<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tabungan Sederhana</title>
    <style>
        /* CSS sama seperti sebelumnya */
        :root {
            --primary: #3498db;
            --secondary: #2ecc71;
            --danger: #e74c3c;
            --light: #f8f9fa;
            --dark: #343a40;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: var(--primary);
            color: white;
            padding: 15px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
        }
        
        nav ul {
            display: flex;
            list-style: none;
        }
        
        nav ul li {
            margin-left: 20px;
        }
        
        nav ul li a {
            color: white;
            text-decoration: none;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        
        nav ul li a:hover {
            background-color: rgba(255,255,255,0.2);
        }
        
        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
        }
        
        h1, h2, h3 {
            margin-bottom: 15px;
            color: var(--dark);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        input, select, button {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        button {
            background-color: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        button.secondary {
            background-color: var(--secondary);
        }
        
        button.secondary:hover {
            background-color: #27ae60;
        }
        
        button.danger {
            background-color: var(--danger);
        }
        
        button.danger:hover {
            background-color: #c0392b;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: #f2f2f2;
            font-weight: 600;
        }
        
        .actions {
            display: flex;
            gap: 5px;
        }
        
        .actions button {
            width: auto;
            padding: 5px 10px;
            font-size: 14px;
        }
        
        .alert {
            padding: 10px 15px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        
        .alert.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            margin: 10px 0;
            color: var(--primary);
        }
        
        .stat-label {
            color: #666;
            font-size: 14px;
        }
        
        .logout-btn {
            background-color: transparent;
            color: white;
            border: 1px solid white;
            width: auto;
            padding: 5px 15px;
        }
        
        .logout-btn:hover {
            background-color: rgba(255,255,255,0.2);
        }
        
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }
            
            nav ul {
                margin-top: 15px;
                justify-content: center;
            }
            
            nav ul li {
                margin: 0 10px;
            }
            
            .actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container header-content">
            <div class="logo">TabunganKu</div>
            <nav>
                <ul>
                    <li><a href="#" class="nav-link" data-page="home">Beranda</a></li>
                    <li><a href="#" class="nav-link" data-page="nasabah" id="nasabah-nav">Nasabah</a></li>
                    <li><a href="#" class="nav-link" data-page="admin" id="admin-nav">Admin</a></li>
                    <li><button class="logout-btn" id="logout-btn">Logout</button></li>
                </ul>
            </nav>
        </div>
    </header>

    <div class="container">
        <!-- Halaman Login -->
        <div id="login-page" class="page active">
            <div class="card">
                <h2>Login Admin</h2>
                <form id="login-form">
                    <div class="form-group">
                        <label for="username">Username</label>
                        <input type="text" id="username" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" required>
                    </div>
                    <button type="submit">Login</button>
                </form>
                <div id="login-message"></div>
            </div>
        </div>

        <!-- Halaman Beranda -->
        <div id="home-page" class="page">
            <h1>Dashboard Tabungan</h1>
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-label">Total Nasabah</div>
                    <div class="stat-value" id="total-nasabah">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Saldo</div>
                    <div class="stat-value" id="total-saldo">Rp 0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Saldo Rata-rata</div>
                    <div class="stat-value" id="rata-saldo">Rp 0</div>
                </div>
            </div>
            
            <div class="card">
                <h2>Daftar Nasabah</h2>
                <table id="nasabah-table-home">
                    <thead>
                        <tr>
                            <th>Nama</th>
                            <th>Saldo</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data nasabah akan diisi oleh JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Halaman Admin -->
        <div id="admin-page" class="page">
            <h1>Kelola Nasabah</h1>
            
            <div class="card">
                <h2>Tambah Nasabah Baru</h2>
                <form id="add-nasabah-form">
                    <div class="form-group">
                        <label for="nama">Nama Nasabah</label>
                        <input type="text" id="nama" required>
                    </div>
                    <div class="form-group">
                        <label for="saldo-awal">Saldo Awal</label>
                        <input type="number" id="saldo-awal" value="0" required>
                    </div>
                    <button type="submit" class="secondary">Tambah Nasabah</button>
                </form>
            </div>
            
            <div class="card">
                <h2>Daftar Nasabah</h2>
                <div id="admin-message"></div>
                <table id="nasabah-table-admin">
                    <thead>
                        <tr>
                            <th>Nama</th>
                            <th>Saldo</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data nasabah akan diisi oleh JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Modal Edit Saldo -->
        <div id="edit-modal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000;">
            <div class="card" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 500px;">
                <h2>Edit Saldo</h2>
                <form id="edit-saldo-form">
                    <input type="hidden" id="edit-id">
                    <div class="form-group">
                        <label for="edit-nama">Nama Nasabah</label>
                        <input type="text" id="edit-nama" readonly>
                    </div>
                    <div class="form-group">
                        <label for="edit-saldo">Saldo Saat Ini</label>
                        <input type="number" id="edit-saldo" readonly>
                    </div>
                    <div class="form-group">
                        <label for="jenis-transaksi">Jenis Transaksi</label>
                        <select id="jenis-transaksi">
                            <option value="tambah">Tambah Saldo</option>
                            <option value="kurang">Kurangi Saldo</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="jumlah">Jumlah</label>
                        <input type="number" id="jumlah" min="1" required>
                    </div>
                    <div class="form-group">
                        <label for="saldo-baru">Saldo Baru</label>
                        <input type="number" id="saldo-baru" readonly>
                    </div>
                    <div class="actions">
                        <button type="button" id="cancel-edit">Batal</button>
                        <button type="submit" class="secondary">Simpan</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Base URL untuk API routes - akan menyesuaikan dengan environment
        const API_BASE = window.location.hostname === 'localhost' 
            ? 'http://localhost:3000/api' 
            : '/api';
        
        // Data aplikasi
        let nasabahData = [];
        let isAdminLoggedIn = false;
        
        // Elemen DOM
        const loginPage = document.getElementById('login-page');
        const homePage = document.getElementById('home-page');
        const adminPage = document.getElementById('admin-page');
        const nasabahNav = document.getElementById('nasabah-nav');
        const adminNav = document.getElementById('admin-nav');
        const logoutBtn = document.getElementById('logout-btn');
        const loginForm = document.getElementById('login-form');
        const addNasabahForm = document.getElementById('add-nasabah-form');
        const editSaldoForm = document.getElementById('edit-saldo-form');
        const editModal = document.getElementById('edit-modal');
        const cancelEditBtn = document.getElementById('cancel-edit');
        const jenisTransaksi = document.getElementById('jenis-transaksi');
        const jumlahInput = document.getElementById('jumlah');
        const saldoBaruInput = document.getElementById('saldo-baru');
        
        // Event Listeners
        document.addEventListener('DOMContentLoaded', initApp);
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', navigateToPage);
        });
        logoutBtn.addEventListener('click', logout);
        loginForm.addEventListener('submit', handleLogin);
        addNasabahForm.addEventListener('submit', addNasabah);
        editSaldoForm.addEventListener('submit', updateSaldo);
        cancelEditBtn.addEventListener('click', () => editModal.style.display = 'none');
        jenisTransaksi.addEventListener('change', calculateNewBalance);
        jumlahInput.addEventListener('input', calculateNewBalance);
        
        // Fungsi inisialisasi aplikasi
        async function initApp() {
            // Cek status login
            const savedLoginStatus = localStorage.getItem('isAdminLoggedIn');
            if (savedLoginStatus === 'true') {
                isAdminLoggedIn = true;
                updateUI();
                await loadData();
            } else {
                showPage('login');
            }
        }
        
        // Fungsi navigasi halaman
        function navigateToPage(e) {
            e.preventDefault();
            const page = e.target.getAttribute('data-page');
            showPage(page);
        }
        
        // Fungsi menampilkan halaman
        function showPage(pageName) {
            // Sembunyikan semua halaman
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Tampilkan halaman yang dipilih
            if (pageName === 'home' && isAdminLoggedIn) {
                homePage.classList.add('active');
                loadHomeData();
            } else if (pageName === 'admin' && isAdminLoggedIn) {
                adminPage.classList.add('active');
                loadAdminData();
            } else if (pageName === 'nasabah' && isAdminLoggedIn) {
                homePage.classList.add('active');
                loadHomeData();
            } else {
                loginPage.classList.add('active');
            }
        }
        
        // Fungsi update UI berdasarkan status login
        function updateUI() {
            if (isAdminLoggedIn) {
                nasabahNav.style.display = 'block';
                adminNav.style.display = 'block';
                logoutBtn.style.display = 'block';
                showPage('home');
            } else {
                nasabahNav.style.display = 'none';
                adminNav.style.display = 'none';
                logoutBtn.style.display = 'none';
                showPage('login');
            }
        }
        
        // Fungsi login
        async function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            try {
                const response = await fetch(`${API_BASE}/auth`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    isAdminLoggedIn = true;
                    localStorage.setItem('isAdminLoggedIn', 'true');
                    updateUI();
                    await loadData();
                    showMessage('login-message', 'Login berhasil!', 'success');
                } else {
                    showMessage('login-message', 'Username atau password salah!', 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                showMessage('login-message', 'Terjadi kesalahan saat login', 'error');
            }
        }
        
        // Fungsi logout
        function logout() {
            isAdminLoggedIn = false;
            localStorage.removeItem('isAdminLoggedIn');
            updateUI();
            document.getElementById('login-form').reset();
        }
        
        // Fungsi memuat data dari API
        async function loadData() {
            try {
                const response = await fetch(`${API_BASE}/nasabah`);
                
                if (!response.ok) {
                    throw new Error('Gagal mengambil data');
                }
                
                const data = await response.json();
                nasabahData = data;
                
                // Update UI berdasarkan halaman aktif
                if (homePage.classList.contains('active')) {
                    loadHomeData();
                } else if (adminPage.classList.contains('active')) {
                    loadAdminData();
                }
            } catch (error) {
                console.error('Error:', error);
                showMessage('admin-message', 'Gagal memuat data: ' + error.message, 'error');
            }
        }
        
        // Fungsi menyimpan data melalui API
        async function saveData() {
            try {
                const response = await fetch(`${API_BASE}/nasabah`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(nasabahData)
                });
                
                if (!response.ok) {
                    throw new Error('Gagal menyimpan data');
                }
                
                return true;
            } catch (error) {
                console.error('Error:', error);
                showMessage('admin-message', 'Gagal menyimpan data: ' + error.message, 'error');
                return false;
            }
        }
        
        // Fungsi memuat data untuk halaman beranda
        function loadHomeData() {
            // Update statistik
            document.getElementById('total-nasabah').textContent = nasabahData.length;
            
            const totalSaldo = nasabahData.reduce((sum, nasabah) => sum + nasabah.saldo, 0);
            document.getElementById('total-saldo').textContent = formatRupiah(totalSaldo);
            
            const rataSaldo = nasabahData.length > 0 ? totalSaldo / nasabahData.length : 0;
            document.getElementById('rata-saldo').textContent = formatRupiah(rataSaldo);
            
            // Update tabel nasabah
            const tbody = document.querySelector('#nasabah-table-home tbody');
            tbody.innerHTML = '';
            
            nasabahData.forEach(nasabah => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${nasabah.nama}</td>
                    <td>${formatRupiah(nasabah.saldo)}</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Fungsi memuat data untuk halaman admin
        function loadAdminData() {
            const tbody = document.querySelector('#nasabah-table-admin tbody');
            tbody.innerHTML = '';
            
            nasabahData.forEach((nasabah, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${nasabah.nama}</td>
                    <td>${formatRupiah(nasabah.saldo)}</td>
                    <td class="actions">
                        <button class="secondary" onclick="openEditModal(${index})">Edit Saldo</button>
                        <button class="danger" onclick="deleteNasabah(${index})">Hapus</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Fungsi menambah nasabah
        async function addNasabah(e) {
            e.preventDefault();
            
            const nama = document.getElementById('nama').value;
            const saldoAwal = parseInt(document.getElementById('saldo-awal').value);
            
            const newNasabah = {
                id: Date.now(), // ID sederhana berdasarkan timestamp
                nama: nama,
                saldo: saldoAwal
            };
            
            nasabahData.push(newNasabah);
            
            const saved = await saveData();
            if (saved) {
                showMessage('admin-message', 'Nasabah berhasil ditambahkan!', 'success');
                addNasabahForm.reset();
                loadAdminData();
            }
        }
        
        // Fungsi membuka modal edit saldo
        function openEditModal(index) {
            const nasabah = nasabahData[index];
            
            document.getElementById('edit-id').value = index;
            document.getElementById('edit-nama').value = nasabah.nama;
            document.getElementById('edit-saldo').value = nasabah.saldo;
            document.getElementById('jumlah').value = '';
            document.getElementById('saldo-baru').value = nasabah.saldo;
            
            editModal.style.display = 'block';
        }
        
        // Fungsi menghitung saldo baru
        function calculateNewBalance() {
            const currentBalance = parseInt(document.getElementById('edit-saldo').value);
            const amount = parseInt(document.getElementById('jumlah').value) || 0;
            const transactionType = jenisTransaksi.value;
            
            let newBalance = currentBalance;
            if (transactionType === 'tambah') {
                newBalance = currentBalance + amount;
            } else if (transactionType === 'kurang') {
                newBalance = currentBalance - amount;
            }
            
            document.getElementById('saldo-baru').value = newBalance;
        }
        
        // Fungsi update saldo
        async function updateSaldo(e) {
            e.preventDefault();
            
            const index = document.getElementById('edit-id').value;
            const newBalance = parseInt(document.getElementById('saldo-baru').value);
            
            nasabahData[index].saldo = newBalance;
            
            const saved = await saveData();
            if (saved) {
                showMessage('admin-message', 'Saldo berhasil diperbarui!', 'success');
                editModal.style.display = 'none';
                loadAdminData();
                
                // Jika di halaman beranda, refresh juga data di sana
                if (homePage.classList.contains('active')) {
                    loadHomeData();
                }
            }
        }
        
        // Fungsi menghapus nasabah
        async function deleteNasabah(index) {
            if (confirm('Apakah Anda yakin ingin menghapus nasabah ini?')) {
                nasabahData.splice(index, 1);
                
                const saved = await saveData();
                if (saved) {
                    showMessage('admin-message', 'Nasabah berhasil dihapus!', 'success');
                    loadAdminData();
                    
                    // Jika di halaman beranda, refresh juga data di sana
                    if (homePage.classList.contains('active')) {
                        loadHomeData();
                    }
                }
            }
        }
        
        // Fungsi menampilkan pesan
        function showMessage(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="alert ${type}">${message}</div>`;
            
            // Hapus pesan setelah 3 detik
            setTimeout(() => {
                element.innerHTML = '';
            }, 3000);
        }
        
        // Fungsi format Rupiah
        function formatRupiah(amount) {
            return 'Rp ' + amount.toLocaleString('id-ID');
        }
    </script>
</body>
</html>
